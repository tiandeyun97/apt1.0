<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

    <!-- Bootstrap CSS -->
    <link href="https://cdn.bootcdn.net/ajax/libs/twitter-bootstrap/5.1.3/css/bootstrap.min.css" rel="stylesheet">
    <!-- Font Awesome -->
    <link href="https://cdn.bootcdn.net/ajax/libs/font-awesome/5.15.4/css/all.min.css" rel="stylesheet">
    <!-- Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+SC:wght@400;500;700&display=swap" rel="stylesheet">
    <!-- 自定义样式 -->
    {% load static %}
    <link href="{% static 'consumption_management/css/add_task_consumption.css' %}" rel="stylesheet">
    <!-- 任务状态颜色样式 -->
    <link href="{% static 'consumption_management/css/task_status_colors.css' %}" rel="stylesheet">
    <style>
        /* 可编辑字段样式 */
        .editable-field {
            position: relative;
            display: flex;
            align-items: center;
        }
        
        .editable-field .edit-return-flow-btn {
            opacity: 0;
            transition: opacity 0.2s;
            margin-left: 5px;
        }
        
        .editable-field:hover .edit-return-flow-btn {
            opacity: 1;
        }
        
        /* 触摸设备支持 */
        @media (hover: none) {
            .editable-field .edit-return-flow-btn {
                opacity: 0.5; /* 在触摸设备上保持半透明可见 */
            }
        }
        
        .editable-field .input-group-sm {
            width: 150px;
        }
        
        .editable-field .return-flow-input {
            min-width: 80px;
        }
        
        /* Toast容器样式 */
        #toast-container {
            z-index: 1050;
        }

        /* 增强自适应布局 */
        @media (max-width: 992px) {
            .table-responsive {
                overflow-x: auto;
            }
            
            .info-card .row > div {
                margin-bottom: 10px;
            }
            
            .editable-field .input-group-sm {
                width: 120px;
            }
            
            .btn-action {
                padding: 0.25rem 0.5rem;
            }
        }
        
        @media (max-width: 576px) {
            .btn-action {
                padding: 0.25rem 0.5rem;
                font-size: 0.875rem;
            }
            
            .mobile-hide {
                display: none;
            }
            
            .editable-field .input-group-sm {
                width: 100px;
            }
            
            .page-container {
                padding: 10px;
            }
            
            .table {
                font-size: 0.9rem;
            }
            
            .info-card {
                padding: 15px 10px;
            }
        }
    </style>
</head>
<body>
    {% csrf_token %}
    <div class="page-container">
        <!-- 任务信息卡片 -->
        <div class="info-card">
            <div class="row g-4">
                <div class="col-md-3">
                    <div class="label">任务名称</div>
                    <div class="value">{{ task.name }}</div>
                </div>
                <div class="col-md-3">
                    <div class="label">广告命名</div>
                    <div class="value">{{ task.advert_name }}</div>
                </div>
                <div class="col-md-3">
                    <div class="label">所属项目</div>
                    <div class="value">{{ task.project.ProjectName }}</div>
                </div>
                <div class="col-md-3">
                    <div class="label">任务状态</div>
                    <div class="value">
                        {% if task.status.TaskStatusName == '进行中' %}
                            <span class="badge status-in-progress">{{ task.status.TaskStatusName }}</span>
                        {% elif task.status.TaskStatusName == '包下架待对账' %}
                            <span class="badge status-pending-reconciliation">{{ task.status.TaskStatusName }}</span>
                        {% elif task.status.TaskStatusName == '待开始' %}
                            <span class="badge status-waiting-to-start">{{ task.status.TaskStatusName }}</span>
                        {% elif task.status.TaskStatusName == '暂停' or task.status.TaskStatusName == '已暂停' %}
                            <span class="badge status-paused">{{ task.status.TaskStatusName }}</span>
                        {% elif task.status.TaskStatusName == '以结束待对账' %}
                            <span class="badge status-ended-pending-reconciliation">{{ task.status.TaskStatusName }}</span>
                        {% elif task.status.TaskStatusName == '已结束完成对账' %}
                            <span class="badge status-ended-reconciliation-complete">{{ task.status.TaskStatusName }}</span>
                        {% elif task.status.TaskStatusName == '稍等，等通知就开启' %}
                            <span class="badge status-waiting-for-notification">{{ task.status.TaskStatusName }}</span>
                        {% else %}
                            <span class="badge bg-info">{{ task.status.TaskStatusName }}</span>
                        {% endif %}
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="label">开始日期</div>
                    <div class="value">{{ task.start_date }}</div>
                </div>
                <div class="col-md-3">
                    <div class="label">结束日期</div>
                    <div class="value">{{ task.end_date|default:"未设置" }}</div>
                </div>
                <div class="col-md-3">
                    <div class="label">优化师</div>
                    <div class="value">
                        {% for optimizer in task.optimizer.all %}
                            <span class="badge bg-primary me-1">{{ optimizer.username }}</span>
                        {% empty %}
                            未分配
                        {% endfor %}
                    </div>
                </div>
            </div>
        </div>

        <!-- 消耗明细表格 -->
        <div class="table-card">
            <div class="d-flex justify-content-between align-items-center mb-4">
                <h4 class="m-0"><i class="fas fa-file-invoice-dollar me-2"></i>消耗明细列表</h4>
                <div class="d-flex align-items-center">
                    {% if from_consumption_list %}
                    <a href="{% url 'consumption_stats:consumption_records_list' %}" class="btn btn-outline-secondary btn-action me-2">
                        <i class="fas fa-arrow-left me-1"></i>返回消耗明细
                    </a>
                    {% else %}
                    <a href="#" class="btn btn-outline-secondary btn-action me-2" id="backToTaskListBtn">
                        <i class="fas fa-arrow-left me-1"></i>返回任务列表
                    </a>
                    {% endif %}
                    <button type="button" class="btn btn-primary btn-action" data-bs-toggle="modal" data-bs-target="#addConsumptionModal">
                        <i class="fas fa-plus-circle me-1"></i>新增消耗记录
                    </button>
                </div>
            </div>
            
            <!-- 查询表单 -->
            <div class="search-form card mb-4">
                <div class="card-body">
                    <form method="get" id="searchConsumptionForm">
                        <div class="row g-3 align-items-end">
                            <div class="col-md-3">
                                <label class="form-label"><i class="fas fa-calendar-alt me-1"></i>日期范围</label>
                                <div class="input-group">
                                    <input type="date" class="form-control" name="start_date" placeholder="开始日期" value="{{ request.GET.start_date }}" aria-label="开始日期">
                                    <span class="input-group-text">至</span>
                                    <input type="date" class="form-control" name="end_date" placeholder="结束日期" value="{{ request.GET.end_date }}" aria-label="结束日期">
                                </div>
                            </div>
                            <div class="col-md-2">
                                <label class="form-label"><i class="fas fa-user me-1"></i>创建人</label>
                                <select class="form-select" name="creator" aria-label="创建人">
                                    <option value="">全部创建人</option>
                                    {% for user in creators %}
                                    <option value="{{ user.id }}" {% if request.GET.creator == user.id|stringformat:"s" %}selected{% endif %}>{{ user.username }}</option>
                                    {% endfor %}
                                </select>
                            </div>
                            <div class="col-md-7 text-end d-flex justify-content-end align-items-end">
                                <button type="submit" class="btn btn-primary me-2">
                                    <i class="fas fa-search me-1"></i>查询
                                </button>
                                <a href="{% url 'consumption_stats:add_task_consumption' task.id %}" class="btn btn-outline-secondary">
                                    <i class="fas fa-undo me-1"></i>重置
                                </a>
                            </div>
                        </div>
                    </form>
                </div>
            </div>

            <div class="table-responsive">
                <table class="table custom-table table-hover table-sm table-responsive-stack" id="consumptionTable">
                    <thead>
                        <tr>
                            <th>日期</th>
                            <th>当日消耗</th>
                            <th>回流</th>
                            <th>实际消耗</th>
                            <th class="d-none d-md-table-cell">回流占比</th>
                            <th class="d-none d-md-table-cell">展示量</th>
                            <th class="d-none d-md-table-cell">点击量</th>
                            <th class="d-none d-lg-table-cell">点击转化率</th>
                            <th class="d-none d-lg-table-cell">点击成本</th>
                            <th class="d-none d-md-table-cell">注册人数</th>
                            <th class="d-none d-lg-table-cell">注册转化率</th>
                            <th class="d-none d-lg-table-cell">注册成本</th>
                            <th class="d-none d-md-table-cell">首充人数</th>
                            <th class="d-none d-lg-table-cell">首充转化率</th>
                            <th class="d-none d-lg-table-cell">首充成本</th>
                            <th class="d-none d-lg-table-cell">ECPM</th>
                            <th>创建人</th>
                            <th>操作</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for consumption in consumptions %}
                        <tr data-date="{{ consumption.date|date:'Y-m-d' }}">
                            <td>
                                <span class="date-cell">{{ consumption.date|date:"Y-m-d" }}</span>
                            </td>
                            <td>{{ consumption.daily_consumption|floatformat:2 }}</td>
                            <td>
                                <div class="editable-field" data-consumption-id="{{ consumption.id }}">
                                    <span class="editable-text">{{ consumption.return_flow|floatformat:2 }}</span>
                                    <a href="#" class="edit-return-flow-btn" title="编辑回流">
                                        <i class="fas fa-edit text-primary"></i>
                                    </a>
                                    <div class="edit-form d-none">
                                        <div class="input-group input-group-sm">
                                            <input type="number" class="form-control form-control-sm return-flow-input" value="{{ consumption.return_flow|floatformat:2 }}" step="0.01">
                                            <button class="btn btn-sm btn-primary save-return-flow-btn" type="button">
                                                <i class="fas fa-save"></i>
                                            </button>
                                            <button class="btn btn-sm btn-outline-secondary cancel-edit-btn" type="button">
                                                <i class="fas fa-times"></i>
                                            </button>
                                        </div>
                                    </div>
                                </div>
                            </td>
                            <td id="actual-consumption-{{ consumption.id }}">{{ consumption.actual_consumption|floatformat:2 }}</td>
                            <td class="d-none d-md-table-cell" id="return-flow-ratio-{{ consumption.id }}">{{ consumption.return_flow_ratio }}%</td>
                            <td class="d-none d-md-table-cell">{{ consumption.impressions }}</td>
                            <td class="d-none d-md-table-cell">{{ consumption.clicks }}</td>
                            <td class="d-none d-lg-table-cell">{{ consumption.click_conversion_rate }}%</td>
                            <td class="d-none d-lg-table-cell">{{ consumption.click_cost|floatformat:2 }}</td>
                            <td class="d-none d-md-table-cell">{{ consumption.registrations }}</td>
                            <td class="d-none d-lg-table-cell">{{ consumption.registration_conversion_rate }}%</td>
                            <td class="d-none d-lg-table-cell">{{ consumption.registration_cost|floatformat:2 }}</td>
                            <td class="d-none d-md-table-cell">{{ consumption.first_deposits }}</td>
                            <td class="d-none d-lg-table-cell">{{ consumption.first_deposit_conversion_rate }}%</td>
                            <td class="d-none d-lg-table-cell">{{ consumption.first_deposit_cost|floatformat:2 }}</td>
                            <td class="d-none d-lg-table-cell">{{ consumption.ecpm|floatformat:2 }}</td>
                            <td>{{ consumption.creator.username|default:"-" }}</td>
                            <td>
                                <div class="btn-group">
                                    <button type="button" class="btn btn-sm btn-outline-primary btn-action edit-consumption" 
                                            data-consumption-id="{{ consumption.id }}"
                                            data-bs-toggle="modal" data-bs-target="#addConsumptionModal">
                                        <i class="fas fa-edit"></i>
                                    </button>
                                    <button type="button" class="btn btn-sm btn-outline-danger btn-action delete-consumption"
                                            data-consumption-id="{{ consumption.id }}"
                                            onclick="deleteConsumption('{{ task.id }}', '{{ consumption.id }}')">
                                        <i class="fas fa-trash"></i>
                                    </button>
                                </div>
                            </td>
                        </tr>
                        {% empty %}
                        <tr>
                            <td colspan="18" class="text-center">暂无消耗记录数据</td>
                        </tr>
                        {% endfor %}
                    </tbody>
                    {% if consumptions %}
                    <tfoot>
                        <tr class="fw-bold">
                            <td>
                                <span class="date-cell bg-light">合计</span>
                            </td>
                            <td>{{ total_daily_consumption|floatformat:2 }}</td>
                            <td>{{ total_return_flow|floatformat:2 }}</td>
                            <td>{{ total_actual_consumption|floatformat:2 }}</td>
                            <td class="d-none d-md-table-cell">-</td>
                            <td class="d-none d-md-table-cell">{{ total_impressions }}</td>
                            <td class="d-none d-md-table-cell">{{ total_clicks }}</td>
                            <td class="d-none d-lg-table-cell">-</td>
                            <td class="d-none d-lg-table-cell">-</td>
                            <td class="d-none d-md-table-cell">{{ total_registrations }}</td>
                            <td class="d-none d-lg-table-cell">-</td>
                            <td class="d-none d-lg-table-cell">-</td>
                            <td class="d-none d-md-table-cell">{{ total_first_deposits }}</td>
                            <td class="d-none d-lg-table-cell">-</td>
                            <td class="d-none d-lg-table-cell">-</td>
                            <td class="d-none d-lg-table-cell">-</td>
                            <td>-</td>
                            <td></td>
                        </tr>
                    </tfoot>
                    {% endif %}
                </table>
            </div>
        </div>
    </div>

    <!-- 添加消耗记录弹窗 -->
    <div class="modal fade" id="addConsumptionModal" tabindex="-1" aria-labelledby="addConsumptionModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="addConsumptionModalLabel">
                        <i class="fas fa-plus-circle"></i>添加消耗记录
                    </h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <form method="post" id="consumptionForm" action="">
                        {% csrf_token %}
                        <input type="hidden" id="consumption_id" name="consumption_id" value="">
                        <input type="hidden" id="task-id" value="{{ task.id }}">
                        
                        <div class="row mb-4">
                            <div class="col-md-6">
                                <label for="date" class="form-label">日期</label>
                                <input type="date" class="form-control" id="date" name="date" required>
                            </div>
                            <div class="col-md-6">
                                <label for="daily_consumption" class="form-label">当日消耗</label>
                                <input type="number" step="0.01" class="form-control" id="daily_consumption" name="daily_consumption" required>
                            </div>
                        </div>

                        <div class="row mb-4">
                            <div class="col-md-6">
                                <label for="return_flow" class="form-label">回流</label>
                                <input type="number" step="0.01" class="form-control" id="return_flow" name="return_flow" value="0">
                                <small class="form-text text-muted">输入负数表示退款</small>
                            </div>
                            <div class="col-md-6">
                                <label for="impressions" class="form-label">展示量</label>
                                <input type="number" class="form-control" id="impressions" name="impressions" value="0">
                            </div>
                        </div>

                        <div class="row mb-4">
                            <div class="col-md-6">
                                <label for="clicks" class="form-label">点击量</label>
                                <input type="number" class="form-control" id="clicks" name="clicks" value="0">
                            </div>
                            <div class="col-md-6">
                                <label for="registrations" class="form-label">注册人数</label>
                                <input type="number" class="form-control" id="registrations" name="registrations" value="0">
                            </div>
                        </div>

                        <div class="row mb-4">
                            <div class="col-md-6">
                                <label for="first_deposits" class="form-label">首充人数</label>
                                <input type="number" class="form-control" id="first_deposits" name="first_deposits" value="0">
                            </div>
                        </div>

                        <div class="modal-footer px-0 pb-0">
                            <button type="button" class="btn btn-secondary btn-action" data-bs-dismiss="modal">取消</button>
                            <button type="submit" class="btn btn-primary btn-action">保存消耗记录</button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>

    <!-- jQuery -->
    <script src="https://cdn.bootcdn.net/ajax/libs/jquery/3.6.0/jquery.min.js"></script>
    <!-- Bootstrap Bundle with Popper -->
    <script src="https://cdn.bootcdn.net/ajax/libs/twitter-bootstrap/5.1.3/js/bootstrap.bundle.min.js"></script>
    <!-- 自定义脚本 -->
    <script src="{% static 'consumption_management/js/add_task_consumption.js' %}"></script>
    
    <!-- 增强日期列显示 -->
    <script>
        $(document).ready(function() {
            // 为日期单元格添加工具提示，显示完整日期格式
            $('.date-cell').each(function() {
                let dateText = $(this).text().trim();
                if (dateText !== '合计') {
                    let dateParts = dateText.split('-');
                    if (dateParts.length === 3) {
                        let year = dateParts[0];
                        let month = dateParts[1];
                        let day = dateParts[2];
                        let formattedDate = `${year}年${month}月${day}日`;
                        $(this).attr('title', formattedDate);
                        $(this).attr('data-bs-toggle', 'tooltip');
                        $(this).attr('data-bs-placement', 'top');
                    }
                }
            });
            
            // 初始化所有工具提示
            $('[data-bs-toggle="tooltip"]').tooltip();
            
            // 处理返回任务列表按钮
            $('#backToTaskListBtn').on('click', function(e) {
                e.preventDefault();
                
                // 获取上一个页面的URL（来源页面）
                const referer = document.referrer;
                
                // 检查referer是否包含task_list
                if (referer && referer.includes('/task_management/task/')) {
                    // 使用来源页面的URL返回
                    window.location.href = referer;
                } else {
                    // 默认返回任务列表页
                    window.location.href = "{% url 'task_management:task_list' %}";
                }
            });
            
            // 处理回流字段的内联编辑
            $(document).on('click', '.edit-return-flow-btn', function(e) {
                e.preventDefault();
                const container = $(this).closest('.editable-field');
                container.find('.editable-text, .edit-return-flow-btn').addClass('d-none');
                container.find('.edit-form').removeClass('d-none');
                container.find('.return-flow-input').focus();
            });
            
            // 取消编辑按钮
            $(document).on('click', '.cancel-edit-btn', function() {
                const container = $(this).closest('.editable-field');
                container.find('.edit-form').addClass('d-none');
                container.find('.editable-text, .edit-return-flow-btn').removeClass('d-none');
                
                // 恢复原始值
                const originalValue = container.find('.editable-text').text().trim();
                container.find('.return-flow-input').val(originalValue);
            });
            
            // 保存回流编辑
            $(document).on('click', '.save-return-flow-btn', function() {
                const container = $(this).closest('.editable-field');
                const consumptionId = container.data('consumption-id');
                const newReturnFlow = container.find('.return-flow-input').val();
                
                // 显示加载指示器
                $(this).html('<i class="fas fa-spinner fa-spin"></i>');
                $(this).prop('disabled', true);
                
                // 发送AJAX请求更新回流值
                $.ajax({
                    url: '/consumption/consumption/' + consumptionId + '/update-return-flow/',
                    method: 'POST',
                    contentType: 'application/json',
                    data: JSON.stringify({ return_flow: newReturnFlow }),
                    headers: {
                        'X-CSRFToken': $('input[name="csrfmiddlewaretoken"]').val()
                    },
                    success: function(response) {
                        if (response.success) {
                            // 更新显示的值（数据已从后端格式化为两位小数）
                            container.find('.editable-text').text(response.consumption.return_flow);
                            container.find('.edit-form').addClass('d-none');
                            container.find('.editable-text, .edit-return-flow-btn').removeClass('d-none');
                            
                            // 更新相关字段，显示两位小数
                            $('#actual-consumption-' + consumptionId).text(response.consumption.actual_consumption);
                            $('#return-flow-ratio-' + consumptionId).text(response.consumption.return_flow_ratio + '%');
                            
                            // 显示成功提示
                            showToast('回流更新成功', 'success');
                        } else {
                            showToast('更新失败: ' + response.error, 'error');
                        }
                    },
                    error: function(xhr) {
                        let errorMessage = '更新失败';
                        try {
                            const response = JSON.parse(xhr.responseText);
                            if (response.error) {
                                errorMessage = response.error;
                            }
                        } catch(e) {}
                        showToast(errorMessage, 'error');
                    },
                    complete: function() {
                        // 恢复按钮状态
                        container.find('.save-return-flow-btn').html('<i class="fas fa-save"></i>');
                        container.find('.save-return-flow-btn').prop('disabled', false);
                    }
                });
            });
            
            // 回车键保存
            $(document).on('keydown', '.return-flow-input', function(e) {
                if (e.key === 'Enter') {
                    e.preventDefault();
                    $(this).closest('.editable-field').find('.save-return-flow-btn').click();
                }
                else if (e.key === 'Escape') {
                    e.preventDefault();
                    $(this).closest('.editable-field').find('.cancel-edit-btn').click();
                }
            });
            
            // 简单的Toast通知系统
            function showToast(message, type) {
                // 检查是否已有toast容器
                let toastContainer = document.getElementById('toast-container');
                if (!toastContainer) {
                    toastContainer = document.createElement('div');
                    toastContainer.id = 'toast-container';
                    toastContainer.className = 'position-fixed bottom-0 end-0 p-3';
                    document.body.appendChild(toastContainer);
                }
                
                // 创建toast元素
                const toastId = 'toast-' + Date.now();
                const bgClass = type === 'success' ? 'bg-success' : 'bg-danger';
                const toastHtml = `
                    <div id="${toastId}" class="toast ${bgClass} text-white" role="alert" aria-live="assertive" aria-atomic="true">
                        <div class="d-flex">
                            <div class="toast-body">
                                ${message}
                            </div>
                            <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast" aria-label="关闭"></button>
                        </div>
                    </div>
                `;
                
                // 添加到容器
                toastContainer.innerHTML += toastHtml;
                
                // 初始化并显示toast
                const toastElement = document.getElementById(toastId);
                const toast = new bootstrap.Toast(toastElement, {
                    autohide: true,
                    delay: 3000
                });
                toast.show();
                
                // 监听关闭事件，在关闭后移除元素
                toastElement.addEventListener('hidden.bs.toast', function () {
                    toastElement.remove();
                });
            }
        });
    </script>
</body>
</html> 